<div class="card">
  <div class="flex" style="align-items:center; justify-content:space-between;">
    <h2>Le proposte</h2>
    <button class="btn" (click)="createNew()">+ Nuova proposta</button>
  </div>

  <!-- Filtri stato -->
  <nav class="tabs mt">
    <button (click)="setFilter('all')"       [class.active]="status() === 'all'">Tutte</button>
    <button (click)="setFilter('draft')"     [class.active]="status() === 'draft'">Bozze</button>
    <button (click)="setFilter('submitted')" [class.active]="status() === 'submitted'">Inviate</button>
    <button (click)="setFilter('approved')"  [class.active]="status() === 'approved'">Approvate</button>
    <button (click)="setFilter('rejected')"  [class.active]="status() === 'rejected'">Rifiutate</button>
  </nav>

  <p *ngIf="message()" class="mt">{{ message() }}</p>
  <p *ngIf="loading()" class="mt muted">Caricamento‚Ä¶</p>

  <div class="grid mt" *ngIf="!loading()">
    <div class="event-card" *ngFor="let p of proposals()">

      <div class="title">{{ p.proposal_date | date:'EEEE d MMMM y' }}</div>
      <small class="muted">{{ p.created_at | date:'short' }}</small>

      <div class="meta">
        <span class="badge">Proposto da: {{ p.proposerName }}</span>
        <span class="badge">Stato: {{ p.status }}</span>

        <!-- x piatti ‚Üí click per aprire elenco -->
        <button class="badge ocra linklike" (click)="toggleItems(p.id)">
          {{ p.itemsCount }} piatti
        </button>
      </div>

      <!-- Elenco piatti (toggle) -->
      <div class="items mt-xs" *ngIf="expandedId() === p.id">
        <ul>
          <li *ngFor="let it of p.proposal_dish">
            {{ it.dish.name || '‚Äî' }} <small class="muted">√ó {{ it.quantity || 1 }}</small>
          </li>
        </ul>
      </div>

      <p *ngIf="p.notes" class="mt">{{ p.notes }}</p>

      <!-- Voti: solo se NON sono il proponente -->
      <div class="vote mt-xs" *ngIf="p.app_user?.id !== user()!.id">
        <button class="btn icon"
                [class.active]="p.myVote === 1"
                [disabled]="voting()"
                (click)="vote(p, 1)">üëç Mi piace</button>
        <button class="btn icon"
                [class.active]="p.myVote === -1"
                [disabled]="voting()"
                (click)="vote(p, -1)">üëé Non mi piace</button>
        <span class="muted ml-sm">Piace a {{ p.votesUp }} ¬∑ Non piace a {{ p.votesDown }}</span>
      </div>

      <!-- Azioni: solo del proponente -->
      <div class="actions mt" *ngIf="p.app_user?.id == user()!.id">
        <button class="btn secondary" (click)="edit(p)">Modifica</button>
        <button class="btn" (click)="submit(p)" [disabled]="p.status !== 'draft'">Invia</button>
        <button class="btn" (click)="duplicate(p)">Duplica</button>
        <button class="btn danger" (click)="remove(p)">Elimina</button>
      </div>
    </div>
  </div>

  <p *ngIf="!loading() && proposals().length === 0" class="mt muted">
    Nessuna proposta trovata. Creane una nuova!
  </p>
</div>
